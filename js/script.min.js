/*

Bugs


Small Enhancements


Medium Enhancements


Large Enhancements


Notes
GDP and Population data sourced from 
Bureau of Economic Analysis
http://www.bea.gov/iTable/iTable.cfm?ReqID=9&step=1#reqid=9&step=1&isuri=1

Latitude and Longitude data from Google Geocoding API
https://developers.google.com/maps/documentation/geocoding/

Distance and travel times from Google Distance Matrix API
https://developers.google.com/maps/documentation/distancematrix/

data.msa = [{
	FIPS: 35620,
	FullMSAName: "New York-Northern New Jersey-Long Island, NY-NJ-PA",
	GDP: 1123460,
	GDPPerCapita: 59080,
	Population: 19015911,
	MSACity: "New York-Northern New Jersey-Long Island",
	MSAState: "NY-NJ-PA",
	City: "New York",
	State: "NY",
	geoLat: number,
	geoLng: number,
}]

data.graph = {
	msa: {
		msa: number,
	}
}

data.pairs = [
  { source: "Denver, CO",
    target: "Salt Lake City, UT",
    distance: 12345,
    drive time: { hours: 8, minutes: 45 }
  }, 
  { source: "Reno, NV", target ... }
]

data.graph = {
  "Denver, CO":
    { "Salt Lake City, UT": 12345,
      "Cheyenne, WY": 123
      "Kansas City, MO": 1234 },
  "Salt Lake City, UT": 
    { "Denver, CO": 12345, â€¦ }
}      

*//* global d3 *//* global google *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
// all static variables and object placeholders
var dv={dim:{},data:{},index:{},svg:{},setup:{},get:{},create:{},update:{},calc:{},draw:{},clear:{},util:{},scale:{},path:{},format:{},state:{loading:0}};dv.setup.variables=function(){dv.opt={path:{raw:"data/MSA.csv",data:"data/MSALatLng.csv"},cities:{quant:50,col:"Population",allstates:!1,exclude:{}},states:{exclude:{AK:!0,HI:!0}}};dv.dim.win={w:window.innerWidth||document.documentElement.clientWidth||document.getElementsByTagName("body")[0].clientWidth,h:window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight};dv.dim.win.min=dv.dim.win.w<dv.dim.win.h?dv.dim.win.w:dv.dim.win.h;dv.scale.map=dv.dim.win.w*1.34;dv.dim.svg={w:dv.dim.win.w,h:dv.dim.win.w*.63}};dv.update.loading=function(e){dv.state.loading+=e;dv.state.loading===0&&dv.setup.withData()};dv.update.locating=function(e){dv.state.locating+=e;if(dv.state.locating===0){var t=dv.util.objToCSV(dv.data.raw);d3.select("body").append("div").html(t)}};dv.setup.withoutData=function(){dv.setup.variables();dv.get.data()};dv.setup.withData=function(){dv.setup.cities("cities");dv.setup.links();dv.setup.scales();dv.draw.svg();dv.draw.states();dv.draw.cities()};dv.setup.links=function(){dv.data.links=[];dv.data.highways={};var e,t,n,r,i,s,o,u=dv.data.highways,a=dv.index.msa,f=[],l=[],c=[];for(e=dv.data.msa.length-1;e>=0;e--){t=dv.data.msa[e];if(t.Interstate){f=t.Interstate.split(",");for(s=f.length-1;s>=0;s--){o=f[s];u[o]||(u[o]=[]);u[o].push(t.FIPS)}}}c=d3.keys(u);for(e=c.length-1;e>=0;e--){r=c[e];i=u[r];l=[];for(s=i.length-1;s>=0;s--){n=i[s];t=a[n];l.push(t)}l=dv.util.sortHighway(r,l);u[r]=l}};dv.util.sortHighway=function(e,t){e%2===0?t.sort(function(e,t){return t.geoLng-e.geoLng}):t.sort(function(e,t){return t.geoLat-e.geoLat});return t};dv.setup.compare=function(){var e={},t={},n={},r,i;dv.opt.cities.col="Population";dv.setup.cities("pop");dv.opt.cities.col="GDP";dv.setup.cities("GDP");for(i=dv.data.GDP.length-1;i>=0;i--){r=dv.data.GDP[i];t[r.FIPS]=r}for(i=dv.data.pop.length-1;i>=0;i--){r=dv.data.pop[i];if(t[r.FIPS]||t[r.FIPS]===0){e[r.FIPS]=r;delete t[r.FIPS]}else n[r.FIPS]=r}dv.data.compare={both:e,GDP:t,pop:n}};dv.console=function(e){for(var t=e.length-1;t>=0;t--){var n=e[t];console.log(n.City)}};dv.setup.cities=function(e){dv.data[e]=[];dv.index[e]={};var t=dv.opt.cities,n=dv.opt.states,r=t.col,i=t.quant,s=dv.data[e],o={},u=0,a=dv.data.msa,f=dv.index[e],l,c;a.sort(function(e,t){return t[r]-e[r]});if(t.allstates)while(s.length<=47&&u<a.length){l=a[u].FIPS;c=a[u].State;if(!o[c]&&!n.exclude[c]&&!t.exclude[l]){o[c]=!0;f[l]=s.push(a[u])-1}u++}u=0;while(s.length<i){l=a[u].FIPS;c=a[u].State;!f[l]&&f[l]!==0&&!n.exclude[c]&&!t.exclude[l]&&(f[l]=s.push(a[u])-1);u++}};dv.setup.scales=function(){var e=dv.scale.map;dv.scale.projection=d3.geo.albersUsa().scale(e).translate([e/2.7,e/4.3]);dv.scale.path=d3.geo.path().projection(dv.scale.projection)};dv.draw.svg=function(){dv.svg.main=d3.select("body").append("svg:svg").attr("width",dv.dim.svg.w).attr("height",dv.dim.svg.h).append("svg:g");dv.svg.map=dv.svg.main.append("svg:g").attr("class","map")};dv.draw.states=function(){dv.svg.states=dv.svg.map.append("svg:g").attr("id","states").selectAll(".state").data(dv.data.states).enter().append("svg:path").attr("name",function(e){return e.properties.name}).attr("class","state").attr("d",dv.scale.path)};dv.draw.cities=function(){dv.svg.cities=dv.svg.map.append("svg:g").attr("id","cities").selectAll(".city").data(dv.data.cities).enter().append("svg:circle").attr("r",5).attr("cx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]}).attr("cy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]});dv.svg.labels=dv.svg.map.append("svg:g").attr("id","labels").selectAll(".label").data(dv.data.cities).enter().append("svg:text").attr("dx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]+9}).attr("dy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]+5}).text(function(e){return e.City+" ("+e.FIPS+")"})};dv.get.data=function(){dv.update.loading(2);d3.csv(dv.opt.path.data,function(e,t){dv.data.msa=t;dv.index.msa={};for(var n=t.length-1;n>=0;n--)dv.index.msa[t[n].FIPS]=t[n];dv.update.loading(-1)});d3.json("data/us-states.json",function(e){dv.data.states=e.features;dv.update.loading(-1)})};dv.get.latlng=function(){d3.csv(dv.opt.path.raw,function(e,t){function a(e){r=dv.data.msa[e];i=r.City+", "+r.State;dv.geo.geocode({address:i},function(t,n){if(n===google.maps.GeocoderStatus.OK){s=t[0].geometry.location;dv.data.raw[e].geoLat=s.lat();dv.data.raw[e].geoLng=s.lng()}else console.log("Fail: "+n);dv.update.locating(-1)})}var n=0,r={},i="",s={},o=t.length,u;dv.data.raw=t;u=setInterval(function(){while(n<o&&dv.data.raw[n].geoLat!=="undefined")n++;if(n<o){dv.update.locating(1);a(n);n++}else clearInterval(u)},1500)})};dv.util.objToCSV=function(e){var t=0,n=0,r=0,i=0,s={},o=d3.keys(e[0]),u="",a="";r=e.length;for(t=0;t<r;t++){if(a===""){i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+u+'"';n<i-1&&(a+=",")}a+="</br>"}s=e[t];i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+s[u]+'"';n<i-1&&(a+=",")}a+="</br>"}return a};dv.setup.withoutData();