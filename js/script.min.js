/*

Bugs


Small Enhancements


Medium Enhancements


Large Enhancements


Notes
GDP and Population data sourced from 
Bureau of Economic Analysis
http://www.bea.gov/iTable/iTable.cfm?ReqID=9&step=1#reqid=9&step=1&isuri=1
* Hanford MSA (25260) combined with Visalia (47300)
* Visalia: GDP: 9880	GDP/Capita: 21992	Population: 449254
* Hanford: GDP: 3602	GDP/Capita: 23425	Population: 153767
* Combined: GDP: 13482	GDP/Capita: 22357	Population: 603021

* Added Butte-Helena
* Source: Wikipedia, Per capita income used instead of census GDP
* Helena - FIPS: 30-35600	GDP: 1527	GDP/Capita: 20020	Population: 76277
* Butte - FIPS: 30-11397	GDP: 572	GDP/Capita: 17068	Population: 33525
* Combined: GDP: 2099	GDP/Capita: 19116	Population: 109802

* Added Lake City
* Source: Wikipedia, Per capita income used instead of census GDP
* FIPS: 12-37775	GDP: 1221	GDP/Capita: 18083	Population: 67531

* Need intersection at 222 and 76 Lancaster-Reading and Harrisburg-Philadelphia (PA)

Latitude and Longitude data from Google Geocoding API
https://developers.google.com/maps/documentation/geocoding/

Distance and travel times from Google Distance Matrix API
https://developers.google.com/maps/documentation/distancematrix/

data.msa = [{
	FIPS: 35620,
	FullMSAName: "New York-Northern New Jersey-Long Island, NY-NJ-PA",
	GDP: 1123460,
	GDPPerCapita: 59080,
	Population: 19015911,
	MSACity: "New York-Northern New Jersey-Long Island",
	MSAState: "NY-NJ-PA",
	City: "New York",
	State: "NY",
	geoLat: number,
	geoLng: number,
}]

data.graph = {
	msa: {
		msa: number,
	}
}

data.pairs = [
  { source: "Denver, CO",
    target: "Salt Lake City, UT",
    distance: 12345,
    drive time: { hours: 8, minutes: 45 }
  }, 
  { source: "Reno, NV", target ... }
]

data.graph = {
  "Denver, CO":
    { "Salt Lake City, UT": 12345,
      "Cheyenne, WY": 123
      "Kansas City, MO": 1234 },
  "Salt Lake City, UT": 
    { "Denver, CO": 12345, â€¦ }
}      

*//* global d3 *//* global google *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
// all static variables and object placeholders
var dv={create:{},data:{},dim:{},draw:{},format:{},force:{},get:{},index:{},scale:{},setup:{},sort:{},state:{loading:0},svg:{},update:{},util:{}};dv.setup.variables=function(){dv.opt={path:{raw:"data/MSA.csv",data:"data/MSALatLng.csv"},cities:{quant:50,col:"Population",allstates:!1,exclude:{}},states:{exclude:{AK:!0,HI:!0}}};dv.dim.win={w:window.innerWidth||document.documentElement.clientWidth||document.getElementsByTagName("body")[0].clientWidth,h:window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight};dv.dim.win.min=dv.dim.win.w<dv.dim.win.h?dv.dim.win.w:dv.dim.win.h;dv.scale.map=dv.dim.win.w*1.34;dv.dim.svg={w:dv.dim.win.w,h:dv.dim.win.w*.63};dv.console=function(){var e=0;for(var t=dv.data.msa.length-1;t>=0;t--){var n=dv.data.msa[t];if(n.Population>=175e3&&!n.Highway&&n.State!=="AK"&&n.State!=="HI"){console.log(n.City+", "+n.State);e++}}return e}};dv.update.loading=function(e){dv.state.loading+=e;dv.state.loading===0&&dv.setup.withData()};dv.setup.withoutData=function(){dv.setup.variables();dv.get.data()};dv.setup.withData=function(){dv.create.cities("cities");dv.create.highways();dv.create.links();dv.create.scales();dv.draw.svg();dv.draw.states();dv.draw.cities();dv.draw.hover()};dv.create.cities=function(e){dv.data[e]=[];dv.index[e]={};var t=dv.opt.cities,n=dv.opt.states,r=t.quant,i=dv.data[e],s={},o=0,u=dv.data.msa,a=dv.index[e],f={data:dv.data.msa,indexName:"msa",col:t.col,reverse:!1},l,c;dv.sort.cities(f);if(t.allstates)while(i.length<=47&&o<u.length){l=u[o].FIPS;c=u[o].State;if(!s[c]&&!n.exclude[c]&&!t.exclude[l]){s[c]=!0;a[l]=i.push(u[o])-1}o++}o=0;while(i.length<r){l=u[o].FIPS;c=u[o].State;!a[l]&&a[l]!==0&&!n.exclude[c]&&!t.exclude[l]&&(a[l]=i.push(u[o])-1);o++}};dv.create.highways=function(){dv.data.links=[];dv.data.highways={};var e,t,n,r,i,s,o,u,a=dv.data.highways,f=dv.data.msa,l=dv.index.msa,c=[];for(e=f.length-1;e>=0;e--){t=f[e];if(t.Highway){n=t.Highway.split(",");for(u=n.length-1;u>=0;u--){i=n[u];a[i]||(a[i]=[]);a[i].push(t.FIPS)}}}dv.index.highways=d3.keys(a);c=dv.index.highways;for(e=c.length-1;e>=0;e--){i=c[e];s=a[i];o=[];for(u=s.length-1;u>=0;u--){r=s[u];t=l[r];o.push(t.FIPS)}o=dv.sort.highway(i,o);a[i]=o}};dv.create.links=function(){dv.data.links=[];dv.index.network={};var e=dv.data.highways,t=dv.index.highways,n=dv.index.msa,r=dv.data.links,i=dv.index.network,s={},o={},u,a,f,l,c,h,p,d;for(u=t.length-1;u>=0;u--){f=t[u];l=e[f];for(a=l.length-1;a>=1;a--){c=l[a];p=n[c];h=l[a-1];d=n[h];s={geoLng:p.geoLng,geoLat:p.geoLat,fips:p.fips};o={geoLng:d.geoLng,geoLat:d.geoLat,fips:d.fips};r.push({source:s,target:o,Highway:f});i[c]=i[c]||{};i[h]=i[h]||{};i[c][h]||(i[c][h]=10);i[h][c]||(i[h][c]=10)}}};dv.sort.highway=function(e,t){var n=dv.index.msa;e%2===0?t.sort(function(e,t){return n[t].geoLng-n[e].geoLng}):t.sort(function(e,t){return n[t].geoLat-n[e].geoLat});return t};dv.sort.cities=function(e){dv.index[e.indexName]={};var t=e.col,n=e.data,r=dv.index[e.indexName],i,s,o;n.sort(function(n,r){return e.reverse?n[t]-r[t]:r[t]-n[t]});for(i=n.length-1;i>=0;i--){o=n[i];s=o.FIPS;o.index=i;r[s]=o}};dv.create.scales=function(){var e=dv.scale.map;dv.scale.projection=d3.geo.albersUsa().scale(e).translate([e/2.7,e/4.3]);dv.scale.path=d3.geo.path().projection(dv.scale.projection)};dv.draw.svg=function(){dv.svg.main=d3.select("body").append("svg:svg").attr("width",dv.dim.svg.w).attr("height",dv.dim.svg.h).append("svg:g");dv.svg.map=dv.svg.main.append("svg:g").attr("class","map")};dv.draw.states=function(){dv.svg.states=dv.svg.map.append("svg:g").attr("id","states").selectAll(".state").data(dv.data.states).enter().append("svg:path").attr("name",function(e){return e.properties.name}).attr("class","state").attr("d",dv.scale.path)};dv.draw.cities=function(){dv.svg.links=dv.svg.map.append("svg:g").attr("id","links").selectAll(".link").data(dv.data.links).enter().append("svg:line").attr("class","link").attr("x1",function(e){return dv.scale.projection([e.source.geoLng,e.source.geoLat])[0]}).attr("y1",function(e){return dv.scale.projection([e.source.geoLng,e.source.geoLat])[1]}).attr("x2",function(e){return dv.scale.projection([e.target.geoLng,e.target.geoLat])[0]}).attr("y2",function(e){return dv.scale.projection([e.target.geoLng,e.target.geoLat])[1]});dv.svg.cities=dv.svg.map.append("svg:g").attr("id","cities").selectAll(".city").data(dv.data.msa).enter().append("svg:circle").attr("class","city").attr("r",function(e){return e.Population>=175e3?"5":"3"}).attr("cx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]}).attr("cy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]}).style("fill",function(e){return e.State==="HI"||e.State==="AK"?"none":e.Population<175e3?e.Highway?!1:"#AAB":e.Highway?!1:"#900"}).style("stroke",function(e){return e.Highway?!1:"none"}).style("stroke-width",function(e){return e.Population>=175e3?"2px":"1px"}).on("mouseover",function(e){dv.update.showCityHover(event,e)}).on("mouseout",dv.update.hideHover);dv.svg.labels=dv.svg.map.append("svg:g").attr("id","labels").selectAll(".label").data(dv.data.msa).enter().append("svg:text").attr("class","label").attr("dx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]+9}).attr("dy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]+5}).style("display",function(e){return e.Population>1e6?!1:"none"}).text(function(e){return e.City})};dv.draw.hover=function(){dv.svg.hover=d3.select("body").append("div").attr("id","hover")};dv.get.data=function(){dv.update.loading(2);d3.csv(dv.opt.path.data,function(e,t){dv.data.msa=t;dv.update.loading(-1)});d3.json("data/us-states.json",function(e){dv.data.states=e.features;dv.update.loading(-1)})};dv.update.locating=function(e){dv.state.locating+=e;if(dv.state.locating===0){var t=dv.util.objToCSV(dv.data.msa);d3.select("body").append("div").html(t)}};dv.update.showCityHover=function(e,t){var n="<h5>"+t.City+", "+t.State+"</h5><ul>";n+="<li><strong>Population: </strong>"+t.Population+"</li>";n+="<li><strong>GDP: </strong>"+t.GDP+"</li>";n+="<li><strong>Highway(s): </strong>"+t.Highway+"</li>";n+="<li><strong>FIPS: </strong>"+t.FIPS+"</li>";n+="</ul>";dv.update.showHover(e,n)};dv.update.showHover=function(e,t){dv.svg.hover.style("top",e.pageY-80+"px").style("left",e.pageX+20+"px").style("display","block").html(t)};dv.update.hideHover=function(){dv.svg.hover.style("display","none")};dv.get.latlng=function(){d3.csv(dv.opt.path.raw,function(e,t){function a(e){r=dv.data.msa[e];i=r.City+", "+r.State;dv.geo.geocode({address:i},function(t,n){if(n===google.maps.GeocoderStatus.OK){s=t[0].geometry.location;dv.data.raw[e].geoLat=s.lat();dv.data.raw[e].geoLng=s.lng()}else console.log("Fail: "+n);dv.update.locating(-1)})}var n=0,r={},i="",s={},o=t.length,u;dv.data.raw=t;u=setInterval(function(){while(n<o&&dv.data.raw[n].geoLat!=="undefined")n++;if(n<o){dv.update.locating(1);a(n);n++}else clearInterval(u)},1500)})};dv.util.objToCSV=function(e){var t=0,n=0,r=0,i=0,s={},o=d3.keys(e[0]),u="",a="";r=e.length;for(t=0;t<r;t++){if(a===""){i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+u+'"';n<i-1&&(a+=",")}a+="</br>"}s=e[t];i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+s[u]+'"';n<i-1&&(a+=",")}a+="</br>"}return a};dv.setup.withoutData();