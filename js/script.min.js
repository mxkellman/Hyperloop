/*

Bugs


Small Enhancements


Medium Enhancements


Large Enhancements


Notes
GDP and Population data sourced from 
Bureau of Economic Analysis
http://www.bea.gov/iTable/iTable.cfm?ReqID=9&step=1#reqid=9&step=1&isuri=1

Latitude and Longitude data from Google Geocoding API
https://developers.google.com/maps/documentation/geocoding/

Distance and travel times from Google Distance Matrix API
https://developers.google.com/maps/documentation/distancematrix/

data.msa = [{
	FIPS: 35620,
	FullMSAName: "New York-Northern New Jersey-Long Island, NY-NJ-PA",
	GDP: 1123460,
	GDPPerCapita: 59080,
	Population: 19015911,
	MSACity: "New York-Northern New Jersey-Long Island",
	MSAState: "NY-NJ-PA",
	City: "New York",
	State: "NY",
	geoLat: number,
	geoLng: number,
}]

data.graph = {
	msa: {
		msa: number,
	}
}

data.pairs = [
  { source: "Denver, CO",
    target: "Salt Lake City, UT",
    distance: 12345,
    drive time: { hours: 8, minutes: 45 }
  }, 
  { source: "Reno, NV", target ... }
]

data.graph = {
  "Denver, CO":
    { "Salt Lake City, UT": 12345,
      "Cheyenne, WY": 123
      "Kansas City, MO": 1234 },
  "Salt Lake City, UT": 
    { "Denver, CO": 12345, â€¦ }
}      

*//* global d3 *//* global google *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
// all static variables and object placeholders
var dv={create:{},data:{},dim:{},draw:{},format:{},get:{},index:{},scale:{},setup:{},sort:{},state:{loading:0},svg:{},update:{},util:{}};dv.setup.variables=function(){dv.opt={path:{raw:"data/MSA.csv",data:"data/MSALatLng.csv"},cities:{quant:50,col:"Population",allstates:!1,exclude:{}},states:{exclude:{AK:!0,HI:!0}}};dv.dim.win={w:window.innerWidth||document.documentElement.clientWidth||document.getElementsByTagName("body")[0].clientWidth,h:window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight};dv.dim.win.min=dv.dim.win.w<dv.dim.win.h?dv.dim.win.w:dv.dim.win.h;dv.scale.map=dv.dim.win.w*1.34;dv.dim.svg={w:dv.dim.win.w,h:dv.dim.win.w*.63};dv.console=function(){}};dv.update.loading=function(e){dv.state.loading+=e;dv.state.loading===0&&dv.setup.withData()};dv.setup.withoutData=function(){dv.setup.variables();dv.get.data()};dv.setup.withData=function(){dv.create.cities("cities");dv.create.highways();dv.create.links();dv.create.scales();dv.draw.svg();dv.draw.states();dv.draw.cities()};dv.create.cities=function(e){dv.data[e]=[];dv.index[e]={};var t=dv.opt.cities,n=dv.opt.states,r=t.quant,i=dv.data[e],s={},o=0,u=dv.data.msa,a=dv.index[e],f={data:dv.data.msa,indexName:"msa",col:t.col,reverse:!1},l,c;dv.sort.cities(f);if(t.allstates)while(i.length<=47&&o<u.length){l=u[o].FIPS;c=u[o].State;if(!s[c]&&!n.exclude[c]&&!t.exclude[l]){s[c]=!0;a[l]=i.push(u[o])-1}o++}o=0;while(i.length<r){l=u[o].FIPS;c=u[o].State;!a[l]&&a[l]!==0&&!n.exclude[c]&&!t.exclude[l]&&(a[l]=i.push(u[o])-1);o++}};dv.create.highways=function(){dv.data.links=[];dv.data.highways={};var e,t,n,r,i,s,o,u,a=dv.data.highways,f=dv.data.msa,l=dv.index.msa,c=[];for(e=f.length-1;e>=0;e--){t=f[e];if(t.Highway){n=t.Highway.split(",");for(u=n.length-1;u>=0;u--){i=n[u];a[i]||(a[i]=[]);a[i].push(t.FIPS)}}}dv.index.highways=d3.keys(a);c=dv.index.highways;for(e=c.length-1;e>=0;e--){i=c[e];s=a[i];o=[];for(u=s.length-1;u>=0;u--){r=s[u];t=l[r];o.push(t.FIPS)}o=dv.sort.highway(i,o);a[i]=o}};dv.create.links=function(){dv.data.links=[];var e=dv.data.highways,t=dv.index.highways,n=dv.index.msa,r=dv.data.links,i,s,o,u,a,f;for(i=t.length-1;i>=0;i--){o=t[i];u=e[o];for(s=u.length-1;s>=1;s--){a=u[s];f=u[s-1];r.push({source:n[a].index,target:n[f].index,highway:o})}}};dv.sort.highway=function(e,t){e%2===0?t.sort(function(e,t){return t.geoLng-e.geoLng}):t.sort(function(e,t){return t.geoLat-e.geoLat});return t};dv.sort.cities=function(e){dv.index[e.indexName]={};var t=e.col,n=e.data,r=dv.index[e.indexName],i,s,o;n.sort(function(n,r){return e.reverse?n[t]-r[t]:r[t]-n[t]});for(i=n.length-1;i>=0;i--){o=n[i];s=o.FIPS;o.index=i;r[s]=o}};dv.create.scales=function(){var e=dv.scale.map;dv.scale.projection=d3.geo.albersUsa().scale(e).translate([e/2.7,e/4.3]);dv.scale.path=d3.geo.path().projection(dv.scale.projection)};dv.draw.svg=function(){dv.svg.main=d3.select("body").append("svg:svg").attr("width",dv.dim.svg.w).attr("height",dv.dim.svg.h).append("svg:g");dv.svg.map=dv.svg.main.append("svg:g").attr("class","map")};dv.draw.states=function(){dv.svg.states=dv.svg.map.append("svg:g").attr("id","states").selectAll(".state").data(dv.data.states).enter().append("svg:path").attr("name",function(e){return e.properties.name}).attr("class","state").attr("d",dv.scale.path)};dv.draw.cities=function(){dv.svg.cities=dv.svg.map.append("svg:g").attr("id","cities").selectAll(".city").data(dv.data.msa).enter().append("svg:circle").attr("r",5).attr("cx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]}).attr("cy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]});dv.svg.labels=dv.svg.map.append("svg:g").attr("id","labels").selectAll(".label").data(dv.data.cities).enter().append("svg:text").attr("dx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]+9}).attr("dy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]+5}).text(function(e){return e.City+" ("+e.FIPS+")"})};dv.get.data=function(){dv.update.loading(2);d3.csv(dv.opt.path.data,function(e,t){dv.data.msa=t;dv.update.loading(-1)});d3.json("data/us-states.json",function(e){dv.data.states=e.features;dv.update.loading(-1)})};dv.update.locating=function(e){dv.state.locating+=e;if(dv.state.locating===0){var t=dv.util.objToCSV(dv.data.msa);d3.select("body").append("div").html(t)}};dv.get.latlng=function(){d3.csv(dv.opt.path.raw,function(e,t){function a(e){r=dv.data.msa[e];i=r.City+", "+r.State;dv.geo.geocode({address:i},function(t,n){if(n===google.maps.GeocoderStatus.OK){s=t[0].geometry.location;dv.data.raw[e].geoLat=s.lat();dv.data.raw[e].geoLng=s.lng()}else console.log("Fail: "+n);dv.update.locating(-1)})}var n=0,r={},i="",s={},o=t.length,u;dv.data.raw=t;u=setInterval(function(){while(n<o&&dv.data.raw[n].geoLat!=="undefined")n++;if(n<o){dv.update.locating(1);a(n);n++}else clearInterval(u)},1500)})};dv.util.objToCSV=function(e){var t=0,n=0,r=0,i=0,s={},o=d3.keys(e[0]),u="",a="";r=e.length;for(t=0;t<r;t++){if(a===""){i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+u+'"';n<i-1&&(a+=",")}a+="</br>"}s=e[t];i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+s[u]+'"';n<i-1&&(a+=",")}a+="</br>"}return a};dv.setup.withoutData();