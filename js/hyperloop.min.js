/*

Bugs
* Need intersection between Raleigh and Greenville, Rocky Mt and Fayettville

Small Enhancements


Medium Enhancements


Large Enhancements


*//* global d3 */// /* global google */
/* global Graph *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
// all static variables and object placeholders
var dv={data:{},dato:{},keys:{},load:{},process:{},state:{},dim:{},scale:{},path:{},html:{},svg:{},write:{},draw:{},create:{},update:{},calc:{},format:{},util:{}};dv.opt={path:{msa:"data/MSAPlaced.csv",links:"data/Links.csv",highways:"data/Highways.json",statemap:"data/us-states.json"},cities:{quant:50,col:"Population",allstates:!1,exclude:{}},city:{radius:{min:3,max:12},stroke:{min:1,max:2},font:{min:14,max:20},popmin:1e6},rose:{petals:9,distances:[1,1.5,2]},map:{scale:1.34,grid:10}};dv.load.data=function(){dv.update.loadState(3);d3.csv(dv.opt.path.msa,function(e,t){dv.data.msa=t;dv.update.loadState(-1)});d3.csv(dv.opt.path.links,function(e,t){dv.data.links=t;dv.update.loadState(-1)});d3.json(dv.opt.path.statemap,function(e){dv.data.states=e.features;dv.update.loadState(-1)})};dv.process.data=function(){dv.create.index({data:dv.data.msa,indexName:"msa",keyName:"fips",col:"FIPS"});dv.create.network();dv.create.scales();dv.create.paths();dv.draw.links();dv.draw.cities();dv.draw.labels()};dv.create.start=function(){dv.create.variables();dv.load.data();dv.draw.svg()};dv.create.variables=function(){dv.create.dims();dv.html.win.onresize=function(){dv.create.dims()};dv.opt.rose.arc=Math.PI/dv.opt.rose.petals};dv.create.dims=function(){dv.html.win=window||document.documentElement||document.getElementsByTagName("body")[0];dv.dim.win={w:dv.html.win.innerWidth||dv.html.win.clientWidth||dv.html.win.clientWidth,h:dv.html.win.innerHeight||dv.html.win.clientHeight||dv.html.win.clientHeight};dv.dim.win.min=dv.dim.win.w<dv.dim.win.h?dv.dim.win.w:dv.dim.win.h;dv.scale.map=dv.dim.win.w*dv.opt.map.scale;dv.dim.svg={w:dv.dim.win.w,h:dv.dim.win.w}};dv.create.network=function(){dv.dato.network={};var e,t,n,r=dv.dato.network;for(e=dv.data.links.length-1;e>=0;e--){t=dv.data.links[e];r[t.c1fips]=r[t.c1fips]||{};r[t.c2fips]=r[t.c2fips]||{};n=parseInt(t.dist,10);r[t.c1fips][t.c2fips]=r[t.c1fips][t.c2fips]||{dist:n};r[t.c2fips][t.c1fips]=r[t.c2fips][t.c1fips]||{dist:n}}dv.calc.graph=new Graph(r)};dv.create.index=function(e){dv.dato[e.indexName]={};dv.keys[e.keyName]=[];var t,n,r,i=e.col,s=e.data,o=dv.dato[e.indexName],u=dv.keys[e.keyName];for(t=s.length-1;t>=0;t--){n=s[t];r=n[i];o[r]=n;u.push(r)}};dv.create.scales=function(){var e=dv.scale.map,t=dv.opt.city,n=d3.extent(dv.data.msa,function(e){return parseInt(e.Population,10)});dv.scale.projection=d3.geo.albers().scale(e).translate([e/2.7,e/3.5]);dv.path.shape=d3.geo.path().projection(dv.scale.projection);dv.scale.r=d3.scale.pow().exponent(.5).domain(n).rangeRound([t.radius.min,t.radius.max]);dv.scale.strokeW=d3.scale.pow().exponent(.5).domain(n).rangeRound([t.stroke.min,t.stroke.max]);dv.scale.font=d3.scale.pow().exponent(.5).domain([t.popmin,n[1]]).rangeRound([t.font.min,t.font.max]);dv.scale.fill=d3.scale.linear().domain([0,5]).range(["#048","#ffeeee"]);dv.scale.round=function(e){var t=dv.opt.map.grid;return Math.round(e/t)*t};dv.scale.x=d3.scale.linear().domain([0,1]).range([0,dv.dim.svg.w]);dv.scale.y=d3.scale.linear().domain([0,1]).range([0,dv.dim.svg.h]);dv.scale.xRound=function(e){return dv.scale.round(dv.scale.x(e))};dv.scale.yRound=function(e){return dv.scale.round(dv.scale.y(e))}};dv.create.paths=function(){dv.path.shape=d3.svg.line().x(function(e){return dv.scale.xRound(e.x)}).y(function(e){return dv.scale.xRound(e.y)}).interpolate("cardinal-closed");dv.path.arc=d3.svg.arc().outerRadius(function(e){return dv.scale.x(e)}).innerRadius(0).startAngle(function(e,t){return 2*t*dv.opt.rose.arc-dv.opt.rose.arc}).endAngle(function(e,t){return 2*t*dv.opt.rose.arc+dv.opt.rose.arc})};dv.create.rose=function(e){var t,n,r=dv.opt.rose.distances.length;dv.update.allDistances(e);dv.update.allAngles(e);for(t=0;t<r;t++){n=dv.opt.rose.distances[t];dv.create.petals(n,e)}};dv.create.petals=function(e,t){var n,r,i,s,o,u,a=dv.dato.msa[t],f=[];for(n=dv.opt.rose.petals-1;n>=0;n--)f[n]=0;for(n=dv.keys.fips.length-1;n>=0;n--){r=dv.keys.fips[n];i=dv.dato.time[r];s=dv.dato.msa[r];o=dv.dato.petal[r];if(i<e){u=dv.calc.xyDist(s,a);if(!f[o]||u>f[o])f[o]=u}}dv.draw.rose(f,a)};dv.create.shapeOld=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d=dv.dato.msa[t],v=[],m=[],g=[],y=[],b=[];for(n=e.length-1;n>=0;n--){h=e[n];p=dv.dato.msa[h];p.y>=d.y?p.x<=d.x?g.push(p):y.push(p):p.x<=d.x?m.push(p):v.push(p)}b.NE=dv.util.aooSort({array:v,key:"x"});b.SE=dv.util.aooSort({array:y,key:"x",reverse:!0});b.SW=dv.util.aooSort({array:g,key:"x",reverse:!0});b.NW=dv.util.aooSort({array:m,key:"x"});b=v.concat(y,g,m);n=0;while(n<b.length&&b.length>=3){r=(n+1)%b.length;i=(n+2)%b.length;s=(n+3)%b.length;o=(n+4)%b.length;u=dv.calc.xyDist(b[n],d);a=dv.calc.xyDist(b[r],d);f=dv.calc.xyDist(b[i],d);l=dv.calc.xyDist(b[s],d);c=dv.calc.xyDist(b[o],d);if(a<u&&a<c&&f<u&&f<c&&l<u&&l<c){b.splice(r,3);n>=b.length&&(n=b.length-1)}else if(a<u&&a<l&&f<u&&f<l){b.splice(r,2);n>=b.length&&(n=b.length-1)}else if(a<u&&a<f){b.splice(r,1);n>=b.length&&(n=b.length-1)}else n++}return b};dv.create.subset=function(e,t){var n,r,i=[];dv.dato.time||dv.update.allDistances(19740);dv.data.fips=dv.data.fips||d3.keys(dv.dato.time);for(n=dv.data.fips.length-1;n>=0;n--){r=dv.dato.time[dv.data.fips[n]];r>e&&r<=t&&i.push(dv.data.fips[n])}return i};dv.draw.svg=function(){dv.svg.main=d3.select("body").append("svg:svg").attr("width",dv.dim.svg.w).attr("height",dv.dim.svg.h).append("svg:g");dv.svg.map=dv.svg.main.append("svg:g").attr("class","map")};dv.draw.shapes=function(){dv.data.shapes=[];dv.svg.shapes=dv.svg.map.append("svg:g").selectAll("path").data(dv.data.shapes).enter().append("svg:path").style("fill","#048").style("fill-opacity",.35)};dv.draw.states=function(){dv.svg.states=dv.svg.map.append("svg:g").attr("id","states").selectAll(".state").data(dv.data.states).enter().append("svg:path").attr("name",function(e){return e.properties.name}).attr("class","state").attr("d",dv.path.shape)};dv.draw.links=function(){dv.svg.links=dv.svg.map.append("svg:g").attr("id","links").selectAll(".link").data(dv.data.links).enter().append("svg:line").attr("class","link").attr("x1",function(e){return dv.scale.xRound(dv.dato.msa[e.c1fips].x)}).attr("y1",function(e){return dv.scale.yRound(dv.dato.msa[e.c1fips].y)}).attr("x2",function(e){return dv.scale.xRound(dv.dato.msa[e.c2fips].x)}).attr("y2",function(e){return dv.scale.yRound(dv.dato.msa[e.c2fips].y)})};dv.draw.cities=function(){dv.svg.cities=dv.svg.map.append("svg:g").attr("id","cities").selectAll(".city").data(dv.data.msa).enter().append("svg:circle").attr("class","city").attr("r",function(e){return dv.scale.r(e.Population)}).attr("cx",function(e){return dv.scale.xRound(e.x)}).attr("cy",function(e){return dv.scale.yRound(e.y)}).style("stroke-width",function(e){return dv.scale.strokeW(e.Population)}).style("display",function(e){return!e.Highway||e.City==="Junction"?"none":!1}).on("mouseover",function(e){dv.update.cityHover(event,e)}).on("mouseout",dv.hover.hide).on("click",function(e){dv.create.rose(e.FIPS)})};dv.draw.labels=function(){dv.svg.labels=dv.svg.map.append("svg:g").attr("id","labels").selectAll(".label").data(dv.data.msa).enter().append("svg:text").attr("class","label").attr("dx",function(e){return dv.scale.xRound(e.x)+dv.scale.r(e.Population)+dv.scale.strokeW(e.Population)}).attr("dy",function(e){return dv.scale.yRound(e.y)-2}).style("display",function(e){return e.Population>dv.opt.city.popmin||e.State==="Canada"?!1:"none"}).style("font-size",function(e){return dv.scale.font(e.Population)}).text(function(e){return e.City})};dv.draw.rose=function(e,t){dv.svg.rose=dv.svg.rose||[];dv.svg.rose[dv.svg.rose.length]=dv.svg.main.append("svg:g").attr("transform","translate("+dv.scale.xRound(t.x)+","+dv.scale.yRound(t.y)+")").attr("class","rose").selectAll("path").data(e).enter().append("svg:path").attr("d",dv.path.arc)};dv.update.shapes=function(){dv.svg.shapes.transition().attr("d",dv.path.shape)};dv.update.dragged=function(e){var t=dv.scale.round,n=e.FIPS,r=d3.select(this).attr("cx",t(d3.event.x)).attr("cy",t(d3.event.y)),i=t(r.attr("cx")),s=t(r.attr("cy"));dv.svg.links.attr("x1",function(e){return e.c1fips===n?i:this.x1.animVal.value}).attr("y1",function(e){return e.c1fips===n?s:this.y1.animVal.value}).attr("x2",function(e){return e.c2fips===n?i:this.x2.animVal.value}).attr("y2",function(e){return e.c2fips===n?s:this.y2.animVal.value});dv.svg.labels.attr("dx",function(e){if(e.FIPS===n){dv.temp=this;return i+dv.scale.r(e.Population)+dv.scale.strokeW(e.Population)}return this.attributes[1].value}).attr("dy",function(e){return e.FIPS===n?s-2:this.attributes[2].value})};dv.update.dragend=function(e){e.x=Math.round(dv.scale.x.invert(d3.select(this).attr("cx"))*250)/250;e.y=Math.round(dv.scale.y.invert(d3.select(this).attr("cy"))*250)/250};dv.update.drag=d3.behavior.drag().on("drag",dv.update.dragged).on("dragend",dv.update.dragend);dv.update.cityToPlace=function(){var e=1e3;dv.svg.cities.transition().duration(e).attr("cx",function(e){return dv.scale.xRound(e.x)}).attr("cy",function(e){return dv.scale.yRound(e.y)});dv.svg.labels.transition().duration(e).attr("dx",function(e){return dv.scale.xRound(e.x)+dv.scale.r(e.Population)+dv.scale.strokeW(e.Population)}).attr("dy",function(e){return dv.scale.yRound(e.y)-2});dv.svg.links.transition().duration(e).attr("x1",function(e){return dv.scale.xRound(dv.dato.msa[e.c1fips].x)}).attr("y1",function(e){return dv.scale.yRound(dv.dato.msa[e.c1fips].y)}).attr("x2",function(e){return dv.scale.xRound(dv.dato.msa[e.c2fips].x)}).attr("y2",function(e){return dv.scale.yRound(dv.dato.msa[e.c2fips].y)})};dv.update.cityToGeo=function(){var e=1e3;dv.svg.cities.transition().duration(e).attr("cx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]}).attr("cy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]});dv.svg.labels.transition().duration(e).attr("dx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]+dv.scale.r(e.Population)+dv.scale.strokeW(e.Population)}).attr("dy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]-2});dv.svg.links.transition().duration(e).attr("x1",function(e){return dv.scale.projection([e.c1geoLng,e.c1geoLat])[0]}).attr("y1",function(e){return dv.scale.projection([e.c1geoLng,e.c1geoLat])[1]}).attr("x2",function(e){return dv.scale.projection([e.c2geoLng,e.c2geoLat])[0]}).attr("y2",function(e){return dv.scale.projection([e.c2geoLng,e.c2geoLat])[1]})};dv.update.cityHover=function(e,t){var n="<h5>"+t.City+", "+t.State+"</h5><ul>";n+="<li><strong>Population: </strong>"+t.Population+"</li>";n+="<li><strong>FIPS: </strong>"+t.FIPS+"</li>";dv.dato.time&&(n+="<li><strong>Time: </strong>"+dv.format.time(dv.dato.time[t.FIPS])+"</li>");dv.dato.angle&&(n+="<li><strong>Angle: </strong>"+dv.dato.angle[t.FIPS]+" degrees</li>");dv.dato.petal&&(n+="<li><strong>Petal: </strong>"+dv.dato.petal[t.FIPS]+"</li>");n+="</ul>";dv.hover.show(e,n)};dv.update.allDistances=function(e){function s(t){if(!dv.dato.time[t]){r=dv.calc.graph.findShortestPath(e,t);dv.update.allTimes(r)}}var t,n,r,i=[99991,99992,99994,20260,24580,13020,99995,99996,12620,39300,35620,47900,47260,27340,34820,16700,33100,27260,15180,88886,88883,41740,42220,14740];dv.dato.time={};dv.dato.time[e]=0;for(t=i.length-1;t>=0;t--){n=i[t];s(n)}for(t=dv.data.msa.length-1;t>=0;t--){n=dv.data.msa[t].FIPS;s(n)}};dv.update.allAngles=function(e){var t,n,r,i,s=dv.opt.rose.petals,o=dv.opt.rose.arc,u=dv.dato.msa[e];dv.dato.angle={};dv.dato.petal={};for(t=dv.data.msa.length-1;t>=0;t--){n=dv.data.msa[t];i=dv.util.getRad(u.x,u.y,n.x,n.y);dv.dato.angle[n.FIPS]=Math.round(i*180/Math.PI);r=Math.floor(i/o);r=(r+1)%(s*2);r=Math.floor(r/2);dv.dato.petal[n.FIPS]=r}};dv.update.fadeMap=function(){dv.svg.cities.style("fill",function(e){return e.City!=="Junction"?dv.scale.fill(dv.dato.time[e.FIPS]):!1}).style("stroke","#FFF").style("stroke-width",2);dv.svg.links.style("stroke",function(e){return dv.scale.fill(dv.dato.time[e.c1fips])})};dv.update.allTimes=function(e){var t,n,r,i=0,s=e.length;for(t=1;t<s;t++){n=e[t];r=e[t-1];i+=dv.dato.network[n][r].dist;dv.dato.time[n]=dv.dato.time[n]||dv.calc.time(i)}};dv.calc.distance=function(e,t){var n,r,i,s=0,o=dv.calc.graph.findShortestPath(e,t);for(n=o.length-1;n>0;n--){r=o[n];i=o[n-1];s+=dv.dato.network[r][i].dist}return s};dv.calc.time=function(e){var t=e/1610,n=0,r=300,i=760,s=2.2,o=56.2,u=5.4;if(t>s){n+=s/(r/2);t-=s}else{n+=t/(r/2);t=0}if(t>o){n+=o/r;t-=s}else{n+=t/r;t=0}if(t>u){n+=u/(i/2);t-=s}else{n+=t/(i/2);t=0}t>0&&(n+=t/i);return n};dv.calc.xyDist=function(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))};dv.format.distance=function(e){return Math.round(e/1610*10)/10+" miles"};dv.format.time=function(e){function i(e){return e>1||e===0?"s":""}var t,n,r="";t=e*3600;e=Math.floor(t/3600);t-=e*3600;n=Math.floor(t/60);t-=n*60;t=Math.round(t%60,10);e>0&&(r=e+" hour"+i(e)+" ");n>0&&(r+=n+" minute"+i(n));return r};dv.update.loadState=function(e,t){t=t||"data";e=e||1;dv.state[t]=dv.state[t]||0;dv.state[t]+=e;dv.state[t]===0&&dv.process[t]()};dv.util.objToJSON=function(e){var t=JSON.stringify(e);dv.util.consoleToBody(t)};dv.util.aooSort=function(e){e.array.sort(function(t,n){return e.reverse?n[e.key]-t[e.key]:t[e.key]-n[e.key]});return e.array};dv.util.getRad=function(e,t,n,r){var i=n-e===0?Math.PI/2:Math.atan((t-r)/(e-n));n-e===0&&r-t<0?i=0:n-e<0?i=1.5*Math.PI+i:i=Math.PI/2+i;return i};dv.util.aooToCSV=function(e){var t=0,n=0,r=e.length,i=0,s={},o=d3.keys(e[0]),u="",a="";for(t=0;t<r;t++){if(a===""){i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+u+'"';n<i-1&&(a+=",")}a+="</br>"}s=e[t];i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+s[u]+'"';n<i-1&&(a+=",")}a+="</br>"}dv.util.consoleToBody(a)};dv.util.consoleToBody=function(e){dv.html.console||(dv.html.console=d3.select("body").append("div").attr("id","console"));dv.html.console.html(e)};dv.util.console=function(){};dv.hover=dv.hover||{};dv.hover.show=function(e,t){dv.html.hover||dv.hover.create();var n,r,i,s,o,u=dv.dim.win,a=dv.html.win,f={x:a.scrollX,y:a.scrollY},l=dv.opt.hover||{},c=l.margin||10,h=l.offset||10;if(e&&t){n=e.clientX+h;r=e.clientY-h;i=document.getElementById("hover");dv.html.hover.html(t);s=i.offsetHeight;o=i.offsetWidth;if(n+o+c>=u.w){n=n-2*h-o;n=n<f.x?c:n}if(r+s+c>=u.h){r=u.h-c-s;r=r<f.y?u.h-s-c:r}n+=f.x;r+=f.y;dv.html.hover.style("top",r+"px").style("left",n+"px").style("visibility","visible")}};dv.hover.create=function(){dv.html.hover=d3.select("body").append("div").attr("id","hover").style("display","block").attr("visibility","hidden")};dv.hover.hide=function(){dv.html.hover&&dv.html.hover.style("visibility","hidden")};dv.create.start();