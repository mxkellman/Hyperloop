/*

Bugs
* Need intersection between Raleigh and Greenville, Rocky Mt and Fayettville

Small Enhancements


Medium Enhancements


Large Enhancements


*//* global d3 */// /* global google */
/* global Graph *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
// all static variables and object placeholders
var dv={data:{},load:{},process:{},state:{},dim:{},scale:{},html:{},svg:{},write:{},draw:{},create:{},update:{},calc:{},format:{},util:{},index:{},sort:{}};dv.opt={path:{msa:"data/MSAPlaced.csv",links:"data/Links.csv",highways:"data/Highways.json",statemap:"data/us-states.json"},cities:{quant:50,col:"Population",allstates:!1,exclude:{}},city:{radius:{min:3,max:12},stroke:{min:1,max:2},font:{min:14,max:20},popmin:1e6},map:{scale:1.34,grid:10}};dv.load.data=function(){dv.update.loadState(3);d3.csv(dv.opt.path.msa,function(e,t){dv.data.msa=t;dv.update.loadState(-1)});d3.csv(dv.opt.path.links,function(e,t){dv.data.links=t;dv.update.loadState(-1)});d3.json(dv.opt.path.statemap,function(e){dv.data.states=e.features;dv.update.loadState(-1)})};dv.process.data=function(){dv.create.index({data:dv.data.msa,indexName:"msa",col:"FIPS"});dv.create.network();dv.create.scales();dv.draw.links();dv.draw.cities();dv.draw.labels()};dv.create.start=function(){dv.create.variables();dv.load.data();dv.draw.svg()};dv.create.variables=function(){dv.create.dims();dv.html.win.onresize=function(){dv.create.dims()}};dv.create.dims=function(){dv.html.win=window||document.documentElement||document.getElementsByTagName("body")[0];dv.dim.win={w:dv.html.win.innerWidth||dv.html.win.clientWidth||dv.html.win.clientWidth,h:dv.html.win.innerHeight||dv.html.win.clientHeight||dv.html.win.clientHeight};dv.dim.win.min=dv.dim.win.w<dv.dim.win.h?dv.dim.win.w:dv.dim.win.h;dv.scale.map=dv.dim.win.w*dv.opt.map.scale;dv.dim.svg={w:dv.dim.win.w,h:dv.dim.win.w}};dv.create.network=function(){dv.index.network={};var e,t,n,r=dv.index.network;for(e=dv.data.links.length-1;e>=0;e--){t=dv.data.links[e];r[t.c1fips]=r[t.c1fips]||{};r[t.c2fips]=r[t.c2fips]||{};n=parseInt(t.dist,10);r[t.c1fips][t.c2fips]=r[t.c1fips][t.c2fips]||{dist:n};r[t.c2fips][t.c1fips]=r[t.c2fips][t.c1fips]||{dist:n}}dv.calc.graph=new Graph(r)};dv.create.index=function(e){dv.index[e.name]={};dv.index[e.indexName]={};var t,n,r,i=e.col,s=e.data,o=dv.index[e.indexName];for(t=s.length-1;t>=0;t--){n=s[t];r=n[i];o[r]=n}};dv.create.scales=function(){var e=dv.scale.map,t=dv.opt.city,n=d3.extent(dv.data.msa,function(e){return parseInt(e.Population,10)});dv.scale.projection=d3.geo.albers().scale(e).translate([e/2.7,e/3.5]);dv.scale.path=d3.geo.path().projection(dv.scale.projection);dv.scale.r=d3.scale.pow().exponent(.5).domain(n).rangeRound([t.radius.min,t.radius.max]);dv.scale.strokeW=d3.scale.pow().exponent(.5).domain(n).rangeRound([t.stroke.min,t.stroke.max]);dv.scale.font=d3.scale.pow().exponent(.5).domain([t.popmin,n[1]]).rangeRound([t.font.min,t.font.max]);dv.scale.fill=d3.scale.linear().domain([0,5]).range(["#048","#ffeeee"]);dv.scale.round=function(e){var t=dv.opt.map.grid;return Math.round(e/t)*t};dv.scale.x=d3.scale.linear().domain([0,1]).range([0,dv.dim.svg.w]);dv.scale.y=d3.scale.linear().domain([0,1]).range([0,dv.dim.svg.h]);dv.scale.xRound=function(e){return dv.scale.round(dv.scale.x(e))};dv.scale.yRound=function(e){return dv.scale.round(dv.scale.y(e))};dv.scale.shape=d3.svg.line().x(function(e){return dv.scale.xRound(e.x)}).y(function(e){return dv.scale.xRound(e.y)}).interpolate("cardinal-closed")};dv.create.shapes=function(e){e||(e=19740);dv.update.allDistances(e);dv.data.shapes.push(dv.create.shape(dv.create.subset(0,1),e));dv.data.shapes.push(dv.create.shape(dv.create.subset(1,2),e));dv.svg.shapes=dv.svg.map.append("svg:g").selectAll("path").data(dv.data.shapes).enter().append("svg:path").style("fill","#048").style("fill-opacity",.35).attr("d",dv.scale.shape)};dv.create.subset=function(e,t){var n,r,i=[];dv.index.time||dv.update.allDistances(19740);dv.data.fips=dv.data.fips||d3.keys(dv.index.time);for(n=dv.data.fips.length-1;n>=0;n--){r=dv.index.time[dv.data.fips[n]];r>e&&r<=t&&i.push(dv.data.fips[n])}return i};dv.create.shape=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p=dv.index.msa[t],d=[],v=[],m=[],g=[],y=[];for(n=e.length-1;n>=0;n--){u=e[n];a=dv.index.msa[u];a.y>=p.y?a.x<=p.x?m.push(a):g.push(a):a.x<=p.x?v.push(a):d.push(a)}y.NE=dv.util.aooSort({array:d,key:"x"});y.SE=dv.util.aooSort({array:g,key:"x",reverse:!0});y.SW=dv.util.aooSort({array:m,key:"x",reverse:!0});y.NW=dv.util.aooSort({array:v,key:"x"});y=d.concat(g,m,v);n=0;o=0;while(n<y.length&&y.length>=3&&o<60){r=(n+1)%y.length;i=(n+2)%y.length;s=(n+3)%y.length;f=dv.calc.xyDist(y[n],p);l=dv.calc.xyDist(y[r],p);c=dv.calc.xyDist(y[i],p);h=dv.calc.xyDist(y[s],p);if(l<f&&l<h&&c<f&&c<h){y.splice(r,2);n>=y.length&&(n=y.length-1);o++}else if(l<f&&l<c){y.splice(r,1);n>=y.length&&(n=y.length-1);o++}else n++}return y};dv.draw.svg=function(){dv.svg.main=d3.select("body").append("svg:svg").attr("width",dv.dim.svg.w).attr("height",dv.dim.svg.h).append("svg:g");dv.svg.map=dv.svg.main.append("svg:g").attr("class","map")};dv.draw.shapes=function(){dv.data.shapes=[];dv.svg.shapes=dv.svg.map.append("svg:g").selectAll("path").data(dv.data.shapes).enter().append("svg:path").style("fill","#048").style("fill-opacity",.35)};dv.draw.states=function(){dv.svg.states=dv.svg.map.append("svg:g").attr("id","states").selectAll(".state").data(dv.data.states).enter().append("svg:path").attr("name",function(e){return e.properties.name}).attr("class","state").attr("d",dv.scale.path)};dv.draw.links=function(){dv.svg.links=dv.svg.map.append("svg:g").attr("id","links").selectAll(".link").data(dv.data.links).enter().append("svg:line").attr("class","link").attr("x1",function(e){return dv.scale.xRound(dv.index.msa[e.c1fips].x)}).attr("y1",function(e){return dv.scale.yRound(dv.index.msa[e.c1fips].y)}).attr("x2",function(e){return dv.scale.xRound(dv.index.msa[e.c2fips].x)}).attr("y2",function(e){return dv.scale.yRound(dv.index.msa[e.c2fips].y)})};dv.draw.cities=function(){dv.svg.cities=dv.svg.map.append("svg:g").attr("id","cities").selectAll(".city").data(dv.data.msa).enter().append("svg:circle").attr("class","city").attr("r",function(e){return dv.scale.r(e.Population)}).attr("cx",function(e){return dv.scale.xRound(e.x)}).attr("cy",function(e){return dv.scale.yRound(e.y)}).style("stroke-width",function(e){return dv.scale.strokeW(e.Population)}).style("display",function(e){return!e.Highway||e.City==="Junction"?"none":!1}).on("mouseover",function(e){dv.update.cityHover(event,e)}).on("mouseout",dv.hover.hide).on("click",function(e){dv.update.allDistances(e.FIPS)})};dv.draw.labels=function(){dv.svg.labels=dv.svg.map.append("svg:g").attr("id","labels").selectAll(".label").data(dv.data.msa).enter().append("svg:text").attr("class","label").attr("dx",function(e){return dv.scale.xRound(e.x)+dv.scale.r(e.Population)+dv.scale.strokeW(e.Population)}).attr("dy",function(e){return dv.scale.yRound(e.y)-2}).style("display",function(e){return e.Population>dv.opt.city.popmin||e.State==="Canada"?!1:"none"}).style("font-size",function(e){return dv.scale.font(e.Population)}).text(function(e){return e.City})};dv.update.shapes=function(){dv.svg.shapes.transition().attr("d",dv.scale.path)};dv.update.dragged=function(e){var t=dv.scale.round,n=e.FIPS,r=d3.select(this).attr("cx",t(d3.event.x)).attr("cy",t(d3.event.y)),i=t(r.attr("cx")),s=t(r.attr("cy"));dv.svg.links.attr("x1",function(e){return e.c1fips===n?i:this.x1.animVal.value}).attr("y1",function(e){return e.c1fips===n?s:this.y1.animVal.value}).attr("x2",function(e){return e.c2fips===n?i:this.x2.animVal.value}).attr("y2",function(e){return e.c2fips===n?s:this.y2.animVal.value});dv.svg.labels.attr("dx",function(e){if(e.FIPS===n){dv.temp=this;return i+dv.scale.r(e.Population)+dv.scale.strokeW(e.Population)}return this.attributes[1].value}).attr("dy",function(e){return e.FIPS===n?s-2:this.attributes[2].value})};dv.update.dragend=function(e){e.x=Math.round(dv.scale.x.invert(d3.select(this).attr("cx"))*250)/250;e.y=Math.round(dv.scale.y.invert(d3.select(this).attr("cy"))*250)/250};dv.update.drag=d3.behavior.drag().on("drag",dv.update.dragged).on("dragend",dv.update.dragend);dv.update.cityToPlace=function(){var e=1e3;dv.svg.cities.transition().duration(e).attr("cx",function(e){return dv.scale.xRound(e.x)}).attr("cy",function(e){return dv.scale.yRound(e.y)});dv.svg.labels.transition().duration(e).attr("dx",function(e){return dv.scale.xRound(e.x)+dv.scale.r(e.Population)+dv.scale.strokeW(e.Population)}).attr("dy",function(e){return dv.scale.yRound(e.y)-2});dv.svg.links.transition().duration(e).attr("x1",function(e){return dv.scale.xRound(dv.index.msa[e.c1fips].x)}).attr("y1",function(e){return dv.scale.yRound(dv.index.msa[e.c1fips].y)}).attr("x2",function(e){return dv.scale.xRound(dv.index.msa[e.c2fips].x)}).attr("y2",function(e){return dv.scale.yRound(dv.index.msa[e.c2fips].y)})};dv.update.cityToGeo=function(){var e=1e3;dv.svg.cities.transition().duration(e).attr("cx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]}).attr("cy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]});dv.svg.labels.transition().duration(e).attr("dx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]+dv.scale.r(e.Population)+dv.scale.strokeW(e.Population)}).attr("dy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]-2});dv.svg.links.transition().duration(e).attr("x1",function(e){return dv.scale.projection([e.c1geoLng,e.c1geoLat])[0]}).attr("y1",function(e){return dv.scale.projection([e.c1geoLng,e.c1geoLat])[1]}).attr("x2",function(e){return dv.scale.projection([e.c2geoLng,e.c2geoLat])[0]}).attr("y2",function(e){return dv.scale.projection([e.c2geoLng,e.c2geoLat])[1]})};dv.update.cityHover=function(e,t){var n="<h5>"+t.City+", "+t.State+"</h5><ul>";n+="<li><strong>Population: </strong>"+t.Population+"</li>";n+="<li><strong>Highway(s): </strong>"+t.Highway+"</li>";n+="<li><strong>FIPS: </strong>"+t.FIPS+"</li>";n+="</ul>";dv.hover.show(e,n)};dv.update.allDistances=function(e){function s(t){if(!dv.index.time[t]){r=dv.calc.graph.findShortestPath(e,t);dv.update.allTimes(r)}}var t,n,r,i=[99991,99992,99994,20260,24580,13020,99995,99996,12620,39300,35620,47900,47260,27340,34820,16700,33100,27260,15180,88886,88883,41740,42220,14740];dv.index.time={};dv.index.time[e]=0;for(t=i.length-1;t>=0;t--){n=i[t];s(n)}for(t=dv.data.msa.length-1;t>=0;t--){n=dv.data.msa[t].FIPS;s(n)}dv.svg.cities.style("fill",function(e){return e.City!=="Junction"?dv.scale.fill(dv.index.time[e.FIPS]):!1}).style("stroke","#FFF").style("stroke-width",2);dv.svg.links.style("stroke",function(e){return dv.scale.fill(dv.index.time[e.c1fips])})};dv.update.allTimes=function(e){var t,n,r,i=0,s=e.length;for(t=1;t<s;t++){n=e[t];r=e[t-1];i+=dv.index.network[n][r].dist;dv.index.time[n]=dv.index.time[n]||dv.calc.time(i)}};dv.calc.distance=function(e,t){var n,r,i,s=0,o=dv.calc.graph.findShortestPath(e,t);for(n=o.length-1;n>0;n--){r=o[n];i=o[n-1];s+=dv.index.network[r][i].dist}return s};dv.calc.time=function(e){var t=e/1610,n=0,r=300,i=760,s=2.2,o=56.2,u=5.4;if(t>s){n+=s/(r/2);t-=s}else{n+=t/(r/2);t=0}if(t>o){n+=o/r;t-=s}else{n+=t/r;t=0}if(t>u){n+=u/(i/2);t-=s}else{n+=t/(i/2);t=0}t>0&&(n+=t/i);return n};dv.calc.xyDist=function(e,t){var n=Math.abs(e.x-t.x);n+=Math.abs(e.y-t.y);return n};dv.format.distance=function(e){return Math.round(e/1610*10)/10+" miles"};dv.format.time=function(e){function r(e){return e>1||e===0?"s":""}var t,n;t=e*3600;e=Math.floor(t/3600);t-=e*3600;n=Math.floor(t/60);t-=n*60;t=Math.round(t%60,10);return e+" hour"+r(e)+" "+n+" minute"+r(n)+" and "+t+" second"+r(t)};dv.update.loadState=function(e,t){t=t||"data";e=e||1;dv.state[t]=dv.state[t]||0;dv.state[t]+=e;dv.state[t]===0&&dv.process[t]()};dv.util.objToJSON=function(e){var t=JSON.stringify(e);dv.util.consoleToBody(t)};dv.util.aooSort=function(e){e.array.sort(function(t,n){return e.reverse?n[e.key]-t[e.key]:t[e.key]-n[e.key]});return e.array};dv.util.aooToCSV=function(e){var t=0,n=0,r=e.length,i=0,s={},o=d3.keys(e[0]),u="",a="";for(t=0;t<r;t++){if(a===""){i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+u+'"';n<i-1&&(a+=",")}a+="</br>"}s=e[t];i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+s[u]+'"';n<i-1&&(a+=",")}a+="</br>"}dv.util.consoleToBody(a)};dv.util.consoleToBody=function(e){dv.html.console||(dv.html.console=d3.select("body").append("div").attr("id","console"));dv.html.console.html(e)};dv.util.console=function(){};dv.hover=dv.hover||{};dv.hover.show=function(e,t){dv.html.hover||dv.hover.create();var n,r,i,s,o,u=dv.dim.win,a=dv.html.win,f={x:a.scrollX,y:a.scrollY},l=dv.opt.hover||{},c=l.margin||10,h=l.offset||10;if(e&&t){n=e.clientX+h;r=e.clientY-h;i=document.getElementById("hover");dv.html.hover.html(t);s=i.offsetHeight;o=i.offsetWidth;if(n+o+c>=u.w){n=n-2*h-o;n=n<f.x?c:n}if(r+s+c>=u.h){r=u.h-c-s;r=r<f.y?u.h-s-c:r}n+=f.x;r+=f.y;dv.html.hover.style("top",r+"px").style("left",n+"px").style("visibility","visible")}};dv.hover.create=function(){dv.html.hover=d3.select("body").append("div").attr("id","hover").style("display","block").attr("visibility","hidden")};dv.hover.hide=function(){dv.html.hover&&dv.html.hover.style("visibility","hidden")};dv.create.start();