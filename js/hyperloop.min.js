/*

Bugs
* Need intersection between Raleigh and Greenville, Rocky Mt and Fayettville

Small Enhancements


Medium Enhancements


Large Enhancements


Notes
GDP and Population data sourced from 
Bureau of Economic Analysis
http://www.bea.gov/iTable/iTable.cfm?ReqID=9&step=1#reqid=9&step=1&isuri=1

* Hanford MSA (25260) combined with Visalia (47300)
* Visalia: Population: 449254
* Hanford: Population: 153767
* Combined:	Population: 603021

* Butte-Helena, MT
* Source: Wikipedia
* Helena - FIPS: 30-35600	Population: 76277
* Butte - FIPS: 30-11397	Population: 33525
* Combined: Population: 109802


* Cities Added
* Source: Wikipedia
37775	Lake City, FL	67531
99996	Montreal, Canada	3824221
99995	Toronto, Canada	5583064
99994	Winnipeg, Canada	730018
99993	Calgary, Canada	1214839
99992	Edmonton, Canada	1159869
99991	Vancouver, Canada	2313328

Latitude and Longitude data from Google Geocoding API
https://developers.google.com/maps/documentation/geocoding/

Distance and travel times from Google Distance Matrix API
https://developers.google.com/maps/documentation/distancematrix/

*//* global d3 */// /* global google */
/* global Graph *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
// all static variables and object placeholders
var dv={create:{},calc:{},data:{},dim:{},draw:{},html:{},format:{},force:{},get:{},index:{},scale:{},setup:{},sort:{},state:{},svg:{},update:{},util:{}};dv.opt={path:{msa:"data/MSAPlaced.csv",links:"data/Links.csv",highways:"data/Highways.json",statemap:"data/us-states.json"},cities:{quant:50,col:"Population",allstates:!1,exclude:{}},city:{radius:{min:3,max:12},stroke:{min:1,max:2},font:{min:14,max:20},popmin:1e6},map:{scale:1.34,grid:5}};dv.setup.variables=function(){dv.setup.dims();dv.html.win.onresize=function(){dv.setup.dims()}};dv.setup.dims=function(){dv.html.win=window||document.documentElement||document.getElementsByTagName("body")[0];dv.dim.win={w:dv.html.win.innerWidth||dv.html.win.clientWidth||dv.html.win.clientWidth,h:dv.html.win.innerHeight||dv.html.win.clientHeight||dv.html.win.clientHeight};dv.dim.win.min=dv.dim.win.w<dv.dim.win.h?dv.dim.win.w:dv.dim.win.h;dv.scale.map=dv.dim.win.w*dv.opt.map.scale;dv.dim.svg={w:dv.dim.win.w,h:dv.dim.win.w}};dv.setup.data=function(){dv.create.index({data:dv.data.msa,indexName:"msa",col:"FIPS"});dv.create.network();dv.create.scales();dv.draw.svg();dv.draw.cities()};dv.setup.preData=function(){dv.setup.variables();dv.get.data()};dv.get.data=function(){dv.update.data(3);d3.csv(dv.opt.path.msa,function(e,t){dv.data.msa=t;dv.update.data(-1)});d3.csv(dv.opt.path.links,function(e,t){dv.data.links=t;dv.update.data(-1)});d3.json(dv.opt.path.statemap,function(e){dv.data.states=e.features;dv.update.data(-1)})};dv.update.data=function(e){dv.state.load=dv.state.load||0;dv.state.load+=e;dv.state.load===0&&dv.setup.data()};dv.create.network=function(){dv.index.network={};var e,t,n,r=dv.index.network;for(e=dv.data.links.length-1;e>=0;e--){t=dv.data.links[e];r[t.c1fips]=r[t.c1fips]||{};r[t.c2fips]=r[t.c2fips]||{};n=parseInt(t.dist,10);r[t.c1fips][t.c2fips]=r[t.c1fips][t.c2fips]||{dist:n};r[t.c2fips][t.c1fips]=r[t.c2fips][t.c1fips]||{dist:n}}dv.calc.graph=new Graph(r)};dv.create.index=function(e){dv.index[e.name]={};dv.index[e.indexName]={};var t,n,r,i=e.col,s=e.data,o=dv.index[e.indexName];for(t=s.length-1;t>=0;t--){n=s[t];r=n[i];o[r]=n}};dv.create.scales=function(){var e=dv.scale.map,t=dv.opt.city,n=d3.extent(dv.data.msa,function(e){return parseInt(e.Population,10)});dv.scale.projection=d3.geo.albers().scale(e).translate([e/2.7,e/3.5]);dv.scale.path=d3.geo.path().projection(dv.scale.projection);dv.scale.r=d3.scale.pow().exponent(.5).domain(n).rangeRound([t.radius.min,t.radius.max]);dv.scale.stroke=d3.scale.pow().exponent(.5).domain(n).rangeRound([t.stroke.min,t.stroke.max]);dv.scale.font=d3.scale.pow().exponent(.5).domain([t.popmin,n[1]]).rangeRound([t.font.min,t.font.max]);dv.scale.round=function(e){var t=dv.opt.map.grid;return Math.round(e/t)*t};dv.scale.x=d3.scale.linear().domain([0,1]).range([0,dv.dim.svg.w]);dv.scale.y=d3.scale.linear().domain([0,1]).range([0,dv.dim.svg.h]);dv.scale.xRound=function(e){return dv.scale.round(dv.scale.x(e))};dv.scale.yRound=function(e){return dv.scale.round(dv.scale.y(e))}};dv.draw.svg=function(){dv.svg.main=d3.select("body").append("svg:svg").attr("width",dv.dim.svg.w).attr("height",dv.dim.svg.h).append("svg:g");dv.svg.map=dv.svg.main.append("svg:g").attr("class","map")};dv.draw.states=function(){dv.svg.states=dv.svg.map.append("svg:g").attr("id","states").selectAll(".state").data(dv.data.states).enter().append("svg:path").attr("name",function(e){return e.properties.name}).attr("class","state").attr("d",dv.scale.path)};dv.draw.cities=function(){dv.update.dragged=function(e){var t=dv.scale.round,n=e.FIPS,r=d3.select(this).attr("cx",t(d3.event.x)).attr("cy",t(d3.event.y)),i=t(r.attr("cx")),s=t(r.attr("cy"));dv.svg.links.attr("x1",function(e){return e.c1fips===n?i:this.x1.animVal.value}).attr("y1",function(e){return e.c1fips===n?s:this.y1.animVal.value}).attr("x2",function(e){return e.c2fips===n?i:this.x2.animVal.value}).attr("y2",function(e){return e.c2fips===n?s:this.y2.animVal.value});dv.svg.labels.attr("dx",function(e){if(e.FIPS===n){dv.temp=this;return i+dv.scale.r(e.Population)+dv.scale.stroke(e.Population)}return this.attributes[1].value}).attr("dy",function(e){return e.FIPS===n?s-2:this.attributes[2].value})};dv.update.dragend=function(e){e.x=dv.scale.x.invert(dv.scale.round(d3.select(this).attr("cx")));e.y=dv.scale.y.invert(dv.scale.round(d3.select(this).attr("cy")))};dv.update.drag=d3.behavior.drag().on("drag",dv.update.dragged).on("dragend",dv.update.dragend);dv.ghost={};dv.svg.links=dv.svg.map.append("svg:g").attr("id","links").selectAll(".link").data(dv.data.links).enter().append("svg:line").attr("class","link").attr("x1",function(e){return dv.scale.xRound(dv.index.msa[e.c1fips].x)}).attr("y1",function(e){return dv.scale.yRound(dv.index.msa[e.c1fips].y)}).attr("x2",function(e){return dv.scale.xRound(dv.index.msa[e.c2fips].x)}).attr("y2",function(e){return dv.scale.yRound(dv.index.msa[e.c2fips].y)});dv.svg.cities=dv.svg.map.append("svg:g").attr("id","cities").selectAll(".city").data(dv.data.msa).enter().append("svg:circle").attr("class","city").attr("r",function(e){return dv.scale.r(e.Population)}).attr("cx",function(e){return dv.scale.xRound(e.x)}).attr("cy",function(e){return dv.scale.yRound(e.y)}).style("stroke-width",function(e){return dv.scale.stroke(e.Population)}).style("display",function(e){return e.Highway?!1:"none"}).on("mouseover",function(e){dv.update.cityHover(event,e)}).on("mouseout",dv.hover.hide).call(dv.update.drag);dv.svg.labels=dv.svg.map.append("svg:g").attr("id","labels").selectAll(".label").data(dv.data.msa).enter().append("svg:text").attr("class","label").attr("dx",function(e){return dv.scale.xRound(e.x)+dv.scale.r(e.Population)+dv.scale.stroke(e.Population)}).attr("dy",function(e){return dv.scale.yRound(e.y)-2}).style("display",function(e){return e.Population>dv.opt.city.popmin||e.State==="Canada"?!1:"none"}).style("font-size",function(e){return dv.scale.font(e.Population)}).text(function(e){return e.City})};dv.update.cityToPlace=function(){var e=1e3;dv.svg.cities.transition().duration(e).attr("cx",function(e){return dv.scale.xRound(e.x)}).attr("cy",function(e){return dv.scale.yRound(e.y)});dv.svg.labels.transition().duration(e).attr("dx",function(e){return dv.scale.xRound(e.x)+dv.scale.r(e.Population)+dv.scale.stroke(e.Population)}).attr("dy",function(e){return dv.scale.yRound(e.y)-2});dv.svg.links.transition().duration(e).attr("x1",function(e){return dv.scale.xRound(dv.index.msa[e.c1fips].x)}).attr("y1",function(e){return dv.scale.yRound(dv.index.msa[e.c1fips].y)}).attr("x2",function(e){return dv.scale.xRound(dv.index.msa[e.c2fips].x)}).attr("y2",function(e){return dv.scale.yRound(dv.index.msa[e.c2fips].y)})};dv.update.cityToGeo=function(){var e=1e3;dv.svg.cities.transition().duration(e).attr("cx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]}).attr("cy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]});dv.svg.labels.transition().duration(e).attr("dx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]+dv.scale.r(e.Population)+dv.scale.stroke(e.Population)}).attr("dy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]-2});dv.svg.links.transition().duration(e).attr("x1",function(e){return dv.scale.projection([e.c1geoLng,e.c1geoLat])[0]}).attr("y1",function(e){return dv.scale.projection([e.c1geoLng,e.c1geoLat])[1]}).attr("x2",function(e){return dv.scale.projection([e.c2geoLng,e.c2geoLat])[0]}).attr("y2",function(e){return dv.scale.projection([e.c2geoLng,e.c2geoLat])[1]})};dv.update.cityHover=function(e,t){var n="<h5>"+t.City+", "+t.State+"</h5><ul>";n+="<li><strong>Population: </strong>"+t.Population+"</li>";n+="<li><strong>Highway(s): </strong>"+t.Highway+"</li>";n+="<li><strong>FIPS: </strong>"+t.FIPS+"</li>";n+="</ul>";dv.hover.show(e,n)};dv.calc.distance=function(e,t){var n,r,i,s=0,o=dv.calc.graph.findShortestPath(e,t),u=dv.index.network;for(n=o.length-1;n>0;n--){r=o[n];i=o[n-1];s+=u[r][i].dist}return s};dv.util.aooToCSV=function(e){var t=0,n=0,r=e.length,i=0,s={},o=d3.keys(e[0]),u="",a="";for(t=0;t<r;t++){if(a===""){i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+u+'"';n<i-1&&(a+=",")}a+="</br>"}s=e[t];i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+s[u]+'"';n<i-1&&(a+=",")}a+="</br>"}dv.util.consoleToBody(a)};dv.util.objToJSON=function(e){var t=JSON.stringify(e);dv.util.consoleToBody(t)};dv.util.consoleToBody=function(e){dv.html.console||(dv.html.console=d3.select("body").append("div").attr("id","console"));dv.html.console.html(e)};dv.util.console=function(){};dv.hover=dv.hover||{};dv.hover.show=function(e,t){dv.html.hover||dv.hover.create();var n,r,i,s,o,u=dv.dim.win,a=dv.html.win,f={x:a.scrollX,y:a.scrollY},l=dv.opt.hover||{},c=l.margin||10,h=l.offset||10;if(e&&t){n=e.clientX+h;r=e.clientY-h;i=document.getElementById("hover");dv.html.hover.html(t);s=i.offsetHeight;o=i.offsetWidth;if(n+o+c>=u.w){n=n-2*h-o;n=n<f.x?c:n}if(r+s+c>=u.h){r=u.h-c-s;r=r<f.y?u.h-s-c:r}n+=f.x;r+=f.y;dv.html.hover.style("top",r+"px").style("left",n+"px").style("visibility","visible")}};dv.hover.create=function(){dv.html.hover=d3.select("body").append("div").attr("id","hover").style("display","block").attr("visibility","hidden")};dv.hover.hide=function(){dv.html.hover&&dv.html.hover.style("visibility","hidden")};dv.setup.preData();