/*

Bugs


Small Enhancements


Medium Enhancements


Large Enhancements


Notes
GDP and Population data sourced from 
Bureau of Economic Analysis
http://www.bea.gov/iTable/iTable.cfm?ReqID=9&step=1#reqid=9&step=1&isuri=1

* Hanford MSA (25260) combined with Visalia (47300)
* Visalia: Population: 449254
* Hanford: Population: 153767
* Combined:	Population: 603021

* Butte-Helena, MT
* Source: Wikipedia
* Helena - FIPS: 30-35600	Population: 76277
* Butte - FIPS: 30-11397	Population: 33525
* Combined: Population: 109802


* Cities Added
* Source: Wikipedia
37775	Lake City, FL	67531
99996	Montreal, Canada	3824221
99995	Toronto, Canada	5583064
99994	Winnipeg, Canada	730018
99993	Calgary, Canada	1214839
99992	Edmonton, Canada	1159869
99991	Vancouver, Canada	2313328

Latitude and Longitude data from Google Geocoding API
https://developers.google.com/maps/documentation/geocoding/

Distance and travel times from Google Distance Matrix API
https://developers.google.com/maps/documentation/distancematrix/

*//* global d3 *//* global google *//* global Graph *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
// all static variables and object placeholders
var dv={create:{},calc:{},data:{},dim:{},draw:{},html:{},format:{},force:{},get:{},index:{},scale:{},setup:{},sort:{},state:{},svg:{},update:{},util:{}};dv.setup.variables=function(){dv.opt={path:{msa:"data/MSA.csv",links:"data/Links.csv"},cities:{quant:50,col:"Population",allstates:!1,exclude:{}},city:{radius:{min:3,max:12},stroke:{min:1,max:2},font:{min:14,max:20},popmin:1e6},map:{scale:1.34}};dv.setup.dims();dv.html.win.onresize=function(){dv.setup.dims()}};dv.console=function(){};dv.get.data=function(){dv.update.load(3);d3.csv(dv.opt.path.msa,function(e,t){dv.data.msa=t;dv.update.load(-1)});d3.csv(dv.opt.path.links,function(e,t){dv.data.links=t;dv.update.load(-1)});d3.json("data/us-states.json",function(e){dv.data.states=e.features;dv.update.load(-1)})};dv.update.load=function(e){dv.state.load=dv.state.load||0;dv.state.load+=e;dv.state.load===0&&dv.setup.withData()};dv.setup.withoutData=function(){dv.setup.variables();dv.get.data()};dv.setup.withData=function(){dv.sort.cities({data:dv.data.msa,indexName:"msa",col:dv.opt.cities.col,reverse:!0});dv.create.highways();dv.create.network();dv.create.scales();dv.draw.svg();dv.draw.states();dv.draw.cities()};dv.setup.dims=function(){dv.html.win=window||document.documentElement||document.getElementsByTagName("body")[0];dv.dim.win={w:dv.html.win.innerWidth||dv.html.win.clientWidth||dv.html.win.clientWidth,h:dv.html.win.innerHeight||dv.html.win.clientHeight||dv.html.win.clientHeight};dv.dim.win.min=dv.dim.win.w<dv.dim.win.h?dv.dim.win.w:dv.dim.win.h;dv.scale.map=dv.dim.win.w*dv.opt.map.scale;dv.dim.svg={w:dv.dim.win.w,h:dv.dim.win.w}};dv.create.links=function(){dv.data.links=[];dv.index.network={};var e=dv.data.highways,t=dv.index.highways,n=dv.index.msa,r=dv.data.links,i={},s={},o,u,a,f;for(o=t.length-1;o>=0;o--){a=t[o];f=e[a];for(u=f.length-1;u>=1;u--){i.fips=f[u];i.msa=n[i.fips];i.geoLat=i.msa.geoLat;i.geoLng=i.msa.geoLng;s.fips=f[u-1];s.msa=n[s.fips];s.geoLat=s.msa.geoLat;s.geoLng=s.msa.geoLng;r.push({c1fips:i.fips,c1geoLat:i.geoLat,c1geoLng:i.geoLng,c2fips:s.fips,c2geoLat:s.geoLat,c2geoLng:s.geoLng,Highway:a})}}dv.create.network()};dv.create.network=function(){dv.index.network={};var e,t,n,r=dv.index.network;for(e=dv.data.links.length-1;e>=0;e--){t=dv.data.links[e];r[t.c1fips]=r[t.c1fips]||{};r[t.c2fips]=r[t.c2fips]||{};n=parseInt(t.dist,10);r[t.c1fips][t.c2fips]=r[t.c1fips][t.c2fips]||{dist:n};r[t.c2fips][t.c1fips]=r[t.c2fips][t.c1fips]||{dist:n}}dv.calc.graph=new Graph(r)};dv.sort.cities=function(e){dv.index[e.indexName]={};var t=e.col,n=e.data,r=dv.index[e.indexName],i,s,o;n.sort(function(n,r){return e.reverse?n[t]-r[t]:r[t]-n[t]});for(i=n.length-1;i>=0;i--){o=n[i];s=o.FIPS;o.index=i;r[s]=o}};dv.create.scales=function(){var e=dv.scale.map,t=dv.opt.city,n=d3.extent(dv.data.msa,function(e){return parseInt(e.Population,10)});dv.scale.projection=d3.geo.albers().scale(e).translate([e/2.7,e/3.5]);dv.scale.path=d3.geo.path().projection(dv.scale.projection);dv.scale.r=d3.scale.pow().exponent(.5).domain(n).rangeRound([t.radius.min,t.radius.max]);dv.scale.stroke=d3.scale.pow().exponent(.5).domain(n).rangeRound([t.stroke.min,t.stroke.max]);dv.scale.font=d3.scale.pow().exponent(.5).domain([t.popmin,n[1]]).rangeRound([t.font.min,t.font.max])};dv.draw.svg=function(){dv.svg.main=d3.select("body").append("svg:svg").attr("width",dv.dim.svg.w).attr("height",dv.dim.svg.h).append("svg:g");dv.svg.map=dv.svg.main.append("svg:g").attr("class","map")};dv.draw.states=function(){dv.svg.states=dv.svg.map.append("svg:g").attr("id","states").selectAll(".state").data(dv.data.states).enter().append("svg:path").attr("name",function(e){return e.properties.name}).attr("class","state").attr("d",dv.scale.path)};dv.draw.cities=function(){dv.svg.links=dv.svg.map.append("svg:g").attr("id","links").selectAll(".link").data(dv.data.links).enter().append("svg:line").attr("class","link").attr("x1",function(e){return dv.scale.projection([e.c1geoLng,e.c1geoLat])[0]}).attr("y1",function(e){return dv.scale.projection([e.c1geoLng,e.c1geoLat])[1]}).attr("x2",function(e){return dv.scale.projection([e.c2geoLng,e.c2geoLat])[0]}).attr("y2",function(e){return dv.scale.projection([e.c2geoLng,e.c2geoLat])[1]});dv.svg.cities=dv.svg.map.append("svg:g").attr("id","cities").selectAll(".city").data(dv.data.msa).enter().append("svg:circle").attr("class","city").attr("r",function(e){return dv.scale.r(e.Population)}).attr("cx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]}).attr("cy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]}).style("fill",function(e){return dv.scale.stroke(e.Population)===0?"#900":!1}).style("stroke-width",function(e){return dv.scale.stroke(e.Population)}).style("display",function(e){return!e.Highway||e.City==="Junction"?"none":!1}).on("mouseover",function(e){dv.update.showCityHover(event,e)}).on("mouseout",dv.hover.hide);dv.svg.labels=dv.svg.map.append("svg:g").attr("id","labels").selectAll(".label").data(dv.data.msa).enter().append("svg:text").attr("class","label").attr("dx",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[0]+dv.scale.r(e.Population)+dv.scale.stroke(e.Population)}).attr("dy",function(e){return dv.scale.projection([e.geoLng,e.geoLat])[1]-2}).style("display",function(e){return e.Population>dv.opt.city.popmin?!1:"none"}).style("font-size",function(e){return dv.scale.font(e.Population)}).text(function(e){return e.City})};dv.update.showCityHover=function(e,t){var n="<h5>"+t.City+", "+t.State+"</h5><ul>";n+="<li><strong>Population: </strong>"+t.Population+"</li>";n+="<li><strong>Highway(s): </strong>"+t.Highway+"</li>";n+="<li><strong>FIPS: </strong>"+t.FIPS+"</li>";n+="</ul>";dv.hover.show(e,n)};dv.calc.distance=function(e,t){var n,r,i,s=0,o=dv.calc.graph.findShortestPath(e,t),u=dv.index.network;for(n=o.length-1;n>0;n--){r=o[n];i=o[n-1];s+=u[r][i].dist}return s};dv.create.highways=function(){dv.data.highways={};var e,t,n,r,i,s,o,u,a=dv.data.highways,f=dv.data.msa,l=dv.index.msa,c=[];for(e=f.length-1;e>=0;e--){t=f[e];if(t.Highway){n=t.Highway.split(",");for(u=n.length-1;u>=0;u--){i=n[u];a[i]||(a[i]=[]);a[i].push(t.FIPS)}}}dv.index.highways=d3.keys(a);c=dv.index.highways;for(e=c.length-1;e>=0;e--){i=c[e];s=a[i];o=[];for(u=s.length-1;u>=0;u--){r=s[u];t=l[r];o.push(t.FIPS)}o=dv.sort.highway(i,o);a[i]=o}};dv.sort.highway=function(e,t){var n=dv.index.msa;e%2===0?t.sort(function(e,t){return n[t].geoLng-n[e].geoLng}):t.sort(function(e,t){return n[t].geoLat-n[e].geoLat});return t};dv.update.dist=function(e){dv.state.dist=dv.state.dist||0;dv.state.dist+=e;dv.state.dist===0&&dv.util.aooToCSV(dv.data.links)};dv.get.dist=function(){function f(e){t=o[e];n=new google.maps.LatLng(t.c1geoLat,t.c1geoLng);r=new google.maps.LatLng(t.c2geoLat,t.c2geoLng);a.getDistanceMatrix({origins:[n],destinations:[r],travelMode:google.maps.TravelMode.DRIVING},function(t,n){if(n===google.maps.DistanceMatrixStatus.OK){i=t.rows[0].elements[0];o[e].drivetime=i.duration.value;o[e].dist=i.distance.value;console.log(e)}else console.log("Fail: "+n);dv.update.dist(-1)})}var e,t,n,r,i,s=0,o=dv.data.links,u=o.length,a=new google.maps.DistanceMatrixService;dv.update.dist(1);e=setInterval(function(){dv.update.dist(1);f(s);s++;if(s>=u){dv.update.dist(-1);clearInterval(e)}},2e3)};dv.update.latlng=function(e){dv.state.latlng=dv.state.latlng||0;dv.state.latlng+=e;dv.state.latlng===0&&dv.util.aooToCSV(dv.data.msa)};dv.get.latlng=function(){var e,t,n=0,r={},i="",s={},o=google.maps.Geocoder?new google.maps.Geocoder:function(){console.log("Google services not loaded.")};d3.csv(dv.opt.path.raw,function(u,a){function f(e){r=dv.data.msa[e];i=r.City+", "+r.State;o.geocode({address:i},function(t,n){if(n===google.maps.GeocoderStatus.OK){s=t[0].geometry.location;dv.data.raw[e].geoLat=s.lat();dv.data.raw[e].geoLng=s.lng()}else console.log("Fail: "+n);dv.update.latlng(-1)})}e=a.length;dv.data.raw=a;t=setInterval(function(){while(n<e&&dv.data.raw[n].geoLat!=="undefined")n++;if(n<e){dv.update.latlng(1);f(n);n++}else clearInterval(t)},1500)})};dv.util.aooToCSV=function(e){var t=0,n=0,r=e.length,i=0,s={},o=d3.keys(e[0]),u="",a="";for(t=0;t<r;t++){if(a===""){i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+u+'"';n<i-1&&(a+=",")}a+="</br>"}s=e[t];i=o.length;for(n=0;n<i;n++){u=o[n];a+='"'+s[u]+'"';n<i-1&&(a+=",")}a+="</br>"}dv.util.consoleToBody(a)};dv.util.objToJSON=function(e){var t=JSON.stringify(e);dv.util.consoleToBody(t)};dv.util.consoleToBody=function(e){dv.html.console||(dv.html.console=d3.select("body").append("div").attr("id","console"));dv.html.console.html(e)};dv.hover=dv.hover||{};dv.hover.show=function(e,t){dv.html.hover||dv.hover.create();var n,r,i,s,o,u=dv.dim.win,a=dv.html.win,f={x:a.scrollX,y:a.scrollY},l=dv.opt.hover||{},c=l.margin||10,h=l.offset||10;if(e&&t){n=e.clientX+h;r=e.clientY-h;i=document.getElementById("hover");dv.html.hover.html(t);s=i.offsetHeight;o=i.offsetWidth;if(n+o+c>=u.w){console.log("slipped");n=n-2*h-o;n=n<f.x?c:n}if(r+s+c>=u.h){r=u.h-c-s;r=r<f.y?u.h-s-c:r}n+=f.x;r+=f.y;dv.html.hover.style("top",r+"px").style("left",n+"px").style("visibility","visible")}};dv.hover.create=function(){dv.html.hover=d3.select("body").append("div").attr("id","hover").style("display","block").attr("visibility","hidden")};dv.hover.hide=function(){dv.html.hover&&dv.html.hover.style("visibility","hidden")};dv.setup.withoutData();